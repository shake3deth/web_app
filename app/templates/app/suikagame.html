<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>JavaScriptã‚¹ã‚¤ã‚«ã‚²ãƒ¼ãƒ ï¼ˆé€£ç¶šè½ä¸‹å¯èƒ½ç‰ˆï¼‰</title>
    <style>
        body { 
        margin: 0; 
        overflow: hidden; 
        background-color: #323232; 
        /* ç”»é¢å…¨ä½“ã‚’Flexboxã§ç¸¦ã«ä¸¦ã¹ã‚‹è¨­å®š */
        display: flex; 
        flex-direction: column; 
        align-items: center;
        min-height: 100vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå…¨ä½“ã‚’ä½¿ç”¨ */
    }
    
    /* ğŸŒŸ æ–°è¦è¿½åŠ : ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« ğŸŒŸ */
    #console-bar {
        width: 100%;
        height: 100px; /* ãƒãƒ¼ã®é«˜ã• */
        background-color: #1a1a1a;
        color: white;
        text-align: center;
        line-height: 100px;
        font-size: 24px;
        font-family: sans-serif;
    }

    /* ã‚²ãƒ¼ãƒ ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¦ªè¦ç´  */
    #game-container {
        /* ã‚²ãƒ¼ãƒ ç”»é¢ã‚’ä¸­å¤®ã«é…ç½®ã™ã‚‹ãŸã‚ã®ä½™ç™½ã‚’ä¸Šä¸‹ã«è¿½åŠ  */
        padding-top: 20px; 
    }

    canvas { 
        display: block; 
        /* Matter.jsã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æç”»ã‚’ã‚³ãƒ³ãƒ†ãƒŠå†…ã«åˆã‚ã›ã‚‹ */
        border: 2px solid #555; 
    }
    </style>
</head>
<body>
    <nav class="navbar bg-body-tertiary">
        <div class = "container">
            <a class="navbar-brand" href="/">ãƒ–ãƒ­ã‚°ã‚µã‚¤ãƒˆ</a>
            <a class="nav-link" href="{% url 'game' %}">ã‚¹ã‚¤ã‚«ã‚²ãƒ¼ãƒ ã¸</a>
        </div>
</nav>
    <div id="console-bar">
        ã‚¹ã‚³ã‚¢: 0000 | NEXT: ãƒã‚§ãƒªãƒ¼
    </div>

    <div id="game-container">
        </div>
    <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>

    <script>
        // --- 1. åˆæœŸè¨­å®šã¨Matter.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
        
        // Matter.jsã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã„ã‚„ã™ãå¤‰æ•°ã«ä»£å…¥
        const Engine = Matter.Engine,
              Render = Matter.Render,
              World = Matter.World,
              Bodies = Matter.Bodies,
              Body = Matter.Body, 
              Mouse = Matter.Mouse,
              MouseConstraint = Matter.MouseConstraint,
              Runner = Matter.Runner; 

        // ç”»é¢ã‚µã‚¤ã‚º 
        const SCREEN_WIDTH = 1250;
        const SCREEN_HEIGHT = 500;
        const FLOOR_HEIGHT = 50; 
        const WALL_THICKNESS = 50;

        // ãƒ•ãƒ«ãƒ¼ãƒ„ã®å®šç¾©
        const FRUIT_SPECS = [
            { radius: 20, color: '#d93245', nextId: 1 },  // ID 0: ãƒã‚§ãƒªãƒ¼
            { radius: 25, color: '#e73562', nextId: 2 },  // ID 1: ã‚¤ãƒã‚´
            { radius: 30, color: '#522f60', nextId: 3 },  // ID 2: ãƒ–ãƒ‰ã‚¦
            { radius: 35, color: '#f18d00', nextId: 4 },  // ID 3: ãƒ‡ã‚³ãƒãƒ³
            { radius: 40, color: '#ed6d3d', nextId: 5 },  // ID 4: ã‚«ã‚­
            { radius: 45, color: '#d9333f', nextId: 6 },  // ID 5: ãƒªãƒ³ã‚´
            { radius: 50, color: '#deb887', nextId: 7 },  // ID 6: ãƒŠã‚·
            { radius: 55, color: '#f09199', nextId: 8 },  // ID 7: ãƒ¢ãƒ¢
            { radius: 60, color: '#00fa9a', nextId: 9 },  // ID 8: ãƒ‘ã‚¤ãƒŠãƒƒãƒ—ãƒ«
            { radius: 65, color: '#32cd32', nextId: 10 }, // ID 9: ãƒ¡ãƒ­ãƒ³
            { radius: 70, color: '#228b22', nextId: 10 }, // ID 10: ã‚¹ã‚¤ã‚« (æœ€å¤§)
        ];
        
        // --- è½ä¸‹æ©Ÿæ§‹ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        const MIN_ID = 0; // ãƒã‚§ãƒªãƒ¼
        const MAX_ID = 4; // ã‚«ã‚­
        // â˜… è½ä¸‹çŠ¶æ…‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°ã¯ä¸è¦ã«ãªã‚Šã¾ã—ãŸ
        let nextFruitId = Math.floor(Math.random() * (MAX_ID - MIN_ID + 1)) + MIN_ID; 
        const DROP_LINE_Y = 50;
        // â˜… lastDroppedBody ã‚‚ä¸è¦

        // ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆ
        const engine = Engine.create();
        const world = engine.world;
        world.gravity.y = 1;

        // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ï¼ˆæç”»ã‚¨ãƒ³ã‚¸ãƒ³ï¼‰ã‚’ä½œæˆ
        const render = Render.create({
           element: document.getElementById('game-container'), 
            engine: engine,
            options: {
                width: SCREEN_WIDTH,
                height: SCREEN_HEIGHT,
                wireframes: false, 
                background: '#323232'
            }
        });

        // --- 2. å¢ƒç•Œç·šï¼ˆåºŠã¨å£ï¼‰ã®ä½œæˆ ---
        const floor = Bodies.rectangle(
            SCREEN_WIDTH / 2, SCREEN_HEIGHT - (FLOOR_HEIGHT / 2), SCREEN_WIDTH, FLOOR_HEIGHT, 
            { isStatic: true, restitution: 0.05, render: { fillStyle: '#008b8b' } }
        );
        const leftWall = Bodies.rectangle(
            WALL_THICKNESS / 2, SCREEN_HEIGHT / 2, WALL_THICKNESS, SCREEN_HEIGHT, 
            { isStatic: true, restitution: 0.1, render: { fillStyle: '#008b8b' } }
        );
        const rightWall = Bodies.rectangle(
            SCREEN_WIDTH - (WALL_THICKNESS / 2), SCREEN_HEIGHT / 2, WALL_THICKNESS, SCREEN_HEIGHT, 
            { isStatic: true, restitution: 0.1, render: { fillStyle: '#008b8b' } }
        );
        World.add(world, [floor, leftWall, rightWall]); 

        // --- 3. ãƒ•ãƒ«ãƒ¼ãƒ„ï¼ˆå††ï¼‰ã®ä½œæˆã¨æ“ä½œ ---
        function createCircle(x, y, fruitId) {
            const spec = FRUIT_SPECS[fruitId];
            
            const circle = Bodies.circle(x, y, spec.radius, {
                restitution: 0.05,  
                friction: 0.8,
                label: 'fruit',         
                fruitId: fruitId,       
                isMerging: false,       
                render: { fillStyle: spec.color } 
            });
            World.add(world, circle);
            return circle;
        }

        // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        const mouse = Mouse.create(render.canvas);
        const mouseConstraint = MouseConstraint.create(engine, {
            mouse: mouse,
            constraint: { stiffness: 0.2, render: { visible: false } }
        });
        World.add(world, mouseConstraint);
        render.mouse = mouse;
        
        // â˜…â˜…â˜… ã‚¯ãƒªãƒƒã‚¯ã§ä¸Šéƒ¨ã‹ã‚‰ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’è½ä¸‹ã•ã›ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (é€£ç¶šè½ä¸‹OK) â˜…â˜…â˜…
        render.canvas.addEventListener('mousedown', function(event) {
            // isDropping ã®ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤
            
            const MAX_X = SCREEN_WIDTH - WALL_THICKNESS;
            const MIN_X = WALL_THICKNESS;
            const radius = FRUIT_SPECS[nextFruitId].radius;
            
            const rect = render.canvas.getBoundingClientRect();
            let dropX = event.clientX - rect.left;
            
            // ãƒ•ãƒ«ãƒ¼ãƒ„ã®ç«¯ãŒå£ã®å¤–ã«å‡ºãªã„ã‚ˆã†åˆ¶é™
            dropX = Math.max(MIN_X + radius, Math.min(dropX, MAX_X - radius));
            
            // ç¾åœ¨æº–å‚™ã•ã‚Œã¦ã„ã‚‹ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ã€å›ºå®šã®Yåº§æ¨™ã‹ã‚‰è½ä¸‹ã•ã›ã‚‹
            createCircle(dropX, DROP_LINE_Y, nextFruitId);
            
            // â˜… è½ä¸‹å¾Œã®ãƒ•ãƒ©ã‚°è¨­å®šã‚’å‰Šé™¤
            
            // è½ä¸‹ãŒå§‹ã¾ã£ãŸã‚‰ã€æ¬¡ã®ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æº–å‚™
            nextFruitId = Math.floor(Math.random() * (MAX_ID - MIN_ID + 1)) + MIN_ID;
        });

        // --- 4. è¡çªã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç† (åˆä½“ã¨é£›ã³å‡ºã—é˜²æ­¢) ---
        Matter.Events.on(engine, 'collisionStart', function(event) {
            const pairs = event.pairs;

            for (let i = 0; i < pairs.length; i++) {
                const pair = pairs[i];
                const bodyA = pair.bodyA;
                const bodyB = pair.bodyB;

                if (bodyA.label === 'fruit' && bodyB.label === 'fruit') {
                    
                    if (bodyA.isMerging || bodyB.isMerging) {
                        continue;
                    }

                    if (bodyA.fruitId === bodyB.fruitId) {
                        
                        const currentId = bodyA.fruitId;
                        
                        if (currentId >= FRUIT_SPECS.length - 1) {
                            continue;
                        }

                        bodyA.isMerging = true;
                        bodyB.isMerging = true;
                        pair.isActive = false; 

                        setTimeout(() => {
                            
                            World.remove(world, [bodyA, bodyB]);

                            const nextId = FRUIT_SPECS[currentId].nextId;
                            const newX = (bodyA.position.x + bodyB.position.x) / 2;
                            const newY = (bodyA.position.y + bodyB.position.y) / 2;
                            
                            const newFruit = createCircle(newX, newY, nextId);
                            
                            // é£›ã³å‡ºã—é˜²æ­¢ã®å‡¦ç†: é€Ÿåº¦ã¨å›è»¢ã‚’ãƒªã‚»ãƒƒãƒˆ
                            Body.setVelocity(newFruit, { x: 0, y: 0 }); 
                            Body.setAngularVelocity(newFruit, 0); 
                            newFruit.friction = 0.9;
                            newFruit.isMerging = false;

                        }, 0); 
                    }
                }
            }
        });
        
        // --- 5. ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¨UIã®æç”» ---
        
        // â˜… è½ä¸‹å®Œäº†ãƒ•ãƒ©ã‚°ã®ãƒªã‚»ãƒƒãƒˆï¼ˆafterUpdateï¼‰ã‚¤ãƒ™ãƒ³ãƒˆã¯ä¸è¦ãªãŸã‚å‰Šé™¤

        // æç”»ã®å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (æ¬¡ã®ãƒ•ãƒ«ãƒ¼ãƒ„ã®æç”»)
        Matter.Events.on(render, 'beforeRender', function() {
            // æ¬¡ã«è½ã¨ã™ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ç”»é¢ä¸Šéƒ¨ã«å›ºå®šã—ã¦æç”»
            const spec = FRUIT_SPECS[nextFruitId];
            const context = render.context;

            context.beginPath();
            context.arc(
                SCREEN_WIDTH / 2,     // ç”»é¢ä¸­å¤®ã®Xåº§æ¨™ã«å›ºå®š
                DROP_LINE_Y,          
                spec.radius,          
                0, 
                2 * Math.PI
            );
            context.fillStyle = spec.color;
            context.fill();
            context.lineWidth = 3;
            // é€£ç¶šè½ä¸‹å¯èƒ½ã«ãªã£ãŸãŸã‚ã€æ ç·šã¯å¸¸ã«ç™½è‰²ã§OK
            context.strokeStyle = '#FFFFFF'; 
            context.stroke();
        });
        
        // ç‰©ç†è¨ˆç®—ã®ã‚µãƒ–ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ
        const runner = Runner.create();
        Runner.run(runner, engine); 

        // æç”»ã‚’å®Ÿè¡Œ
        Render.run(render); 
        
        console.log("ã‚²ãƒ¼ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚ç”»é¢ä¸Šéƒ¨ã®ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é€£ç¶šã§è½ã¨ã›ã¾ã™ã€‚");

    </script>
</body>
</html>